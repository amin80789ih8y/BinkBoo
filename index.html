<!DOCTYPE html>
<html dir="rtl">
<head>
    <title>مُحادثات إبداعية</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        *, *::before, *::after {
            -webkit-tap-highlight-color: transparent; /* إزالة التمييز عند النقر */
            box-sizing: border-box;
        }

        body {
            font-family: 'Droid Arabic Kufi', serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
            box-shadow: none;
            background-color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
          padding: 20px;
          background-color: #673ab7;
          color: #fff;
          display: flex;
          align-items: center;
          justify-content: space-between;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          z-index: 10;
          border-bottom-left-radius: 30px; /* حافة مائلة في الأسفل على اليسار */
          border-bottom-right-radius: 30px; /* حافة مائلة في الأسفل على اليمين */
          box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2); /* ظل أنيق */
        }

        .chat-header i {
            font-size: 30px;
            margin-right: 15px;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: scroll;
            padding: 20px;
            margin-top: 74px;
            margin-bottom: 80px;
            background-color: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 25px;
            max-width: 75%;
            clear: both;
            position: relative;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background-color: #e0f0e0;
            float: right;
            text-align: right;
        }

        .ai-message {
            background-color: #d8d8ff;
            float: left;
            text-align: left;
        }

        .ai-message .message-content {
            opacity: 0; /* إخفاء محتوى الرسالة في البداية */
            animation: revealText 0.1s linear forwards; /* تطبيق تأثير الكتابة */
        }

        @keyframes revealText {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .message img {
            max-width: 100%;
            display: block;
            border-radius: 10px;
            margin-top: 10px;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            z-index: 10;
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 12px 18px;
            border: none;
            border: 2px solid #673ab7;
            border-radius: 30px;
            margin-right: 10px;
            font-size: 16px;
            background-color: #f8f9fa;
            font-family: 'Droid Arabic Kufi', serif;
        }

        .chat-input button {
            padding: 12px 20px;
            background-color: #673ab7;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0px 5px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Droid Arabic Kufi', serif;
        }

        .chat-input #image-button {
            background-color: #f0f0f0;
            color: #333;
            margin-left: 0;
            margin-right: 10px;
        }

        .message {
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-options {
            display: flex;
            margin-top: 5px;
        }

        .message-options button {
            background: none;
            border: none;
            padding: 5px;
            margin-right: 8px;
            cursor: pointer;
            color: #673ab7;
        }

        .message-options button i {
            font-size: 20px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            border-radius: 25px;
            max-width: 75%;
            clear: both;
            background-color: #d8d8ff;
            float: left;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #673ab7;
            margin: 0 3px;
            animation: typing 1.5s infinite;
        }

        .typing-indicator.dark-mode span {
          background-color: #673ab7;
        }

        @keyframes typing {
            0% {
                transform: translateY(0);
                opacity: 0.2;
            }
            50% {
                transform: translateY(-3px);
                opacity: 1;
            }
            100% {
                transform: translateY(0);
                opacity: 0.2;
            }
        }

        .notifications-icon {
          position: relative;
          cursor: pointer;
          z-index: 20;
        }

        .notifications-icon .icon-container {
          background: linear-gradient(135deg, #ffc107, #ff5722);
          border-radius: 10px; /* حواف مائلة */
          width: 45px;
          height: 45px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
          transition: all 0.3s ease;
        }

        .notifications-icon:hover .icon-container {
          transform: scale(1.1);
          box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
        }

        .notifications-icon .badge {
          position: absolute;
          top: 10px;
          right: 10px;
          background-color: #dc3545;
          color: #fff;
          border-radius: 50%;
          width: 10px;
          height: 10px;
          display: none; /* إخفاء النقطة في البداية */
        }

        .notifications-icon .badge.show {
            display: block; /* إظهار النقطة عند وجود إشعارات جديدة */
        }

        .notifications-icon i {
          font-size: 22px;
          color: #fff;
        }

        .notifications-popup {
          position: absolute;
          top: 60px;
          right: 20px;
          background-color: #fff;
          border-radius: 10px;
          box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
          min-width: 250px;
          max-width: 350px;
          max-height: 300px;
          overflow-y: auto;
          z-index: 20;
          display: none; /* إخفاء النافذة المنبثقة في البداية */
        }

        .notifications-popup.show {
          display: block;
        }

        .notifications-popup .notification-item {
          padding: 10px;
          border-bottom: 1px solid #eee;
          cursor: pointer;
          transition: background-color 0.3s ease;
        }

        .notifications-popup .notification-item:hover {
          background-color: #f8f9fa;
        }

        .notifications-popup .notification-item.unread {
          background-color: #f0f8ff; /* لون خلفية الإشعار غير المقروء */
        }

        .notifications-popup .notification-item .content {
          font-size: 14px;
          color: #333;
        }

        .notifications-popup .notification-item .timestamp {
          font-size: 12px;
          color: #999;
        }

        .chat-header .title-and-logo {
          display: flex;
          align-items: center;
          justify-content: center;
          flex-grow: 1;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Droid+Arabic+Kufi&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
</head>
<body>
    <div class="chat-container" id="chatContainer">
      <div class="chat-header" id="chatHeader">
        <div class="notifications-icon" title="الإشعارات" onclick="toggleNotifications()">
          <div class="icon-container">
            <i class="fas fa-bell"></i>
            <span class="badge" id="notificationsBadge"></span>
          </div>
          <div class="notifications-popup" id="notificationsPopup">
            <div class="notification-item unread" id="notification1">
              <div class="content">تحديث الموقع جارٍ</div>
              <div class="timestamp"></div>
            </div>
          </div>
        </div>
        <div class="title-and-logo">
          <i class="fas fa-brain"></i>
          <h1>مُحادثات إبداعية</h1>
        </div>
      </div>
        <div class="chat-messages" id="chatMessages">
        </div>
        <div class="chat-input" id="chatInput">
            <input type="text" id="user-input" placeholder="اكتب رسالتك هنا...">
            <input type="file" id="image-input" accept="image/*" style="display: none;">
            <button id="image-button" title="إرسال صورة">🖼️</button>
            <button id="send-button" >إرسال</button>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const imageInput = document.getElementById('image-input');
        const imageButton = document.getElementById('image-button');
        const apiKey = "AIzaSyBGHFaGx0INLT4ZO1RVgbUvslizrTI5rzU";
        let lastUserMessage = '';

        function addMessage(content, sender, type = 'text') {
          const messageElement = document.createElement('div');
          messageElement.classList.add('message', `${sender}-message`);

          if (type === 'text') {
            if (sender === 'ai') {
              // إنشاء عنصر محتوى الرسالة
              const messageContent = document.createElement('div');
              messageContent.classList.add('message-content');
              messageContent.textContent = content;
              messageElement.appendChild(messageContent);
            } else {
              // لا حاجة لتأثير الكتابة لرسائل المستخدم
              messageElement.textContent = content;
            }
          } else if (type === 'image') {
            const imgElement = document.createElement('img');
            imgElement.src = content;
            messageElement.appendChild(imgElement);
          }

          // إضافة خيارات الرسالة بعد محتوى الرسالة
          if (sender === 'ai') {
            const optionsElement = document.createElement('div');
            optionsElement.classList.add('message-options');

            const copyButton = document.createElement('button');
            copyButton.innerHTML = '<i class="far fa-copy"></i>';
            copyButton.title = 'نسخ';
            copyButton.addEventListener('click', () => {
              navigator.clipboard.writeText(content);
            });

            const regenerateButton = document.createElement('button');
            regenerateButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
            regenerateButton.title = 'إعادة إنشاء';
            regenerateButton.addEventListener('click', () => {
              sendMessageToAI(lastUserMessage);
            });

            optionsElement.appendChild(copyButton);
            optionsElement.appendChild(regenerateButton);
            messageElement.appendChild(optionsElement);
          }

          chatMessages.appendChild(messageElement);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function createPrompt(question) {
            const promptTemplate = `
            عند التفاعل مع المستخدم، ركّز على فهم نية السؤال أولاً. إذا كان السؤال بسيطًا مثل 'مرحبًا'، تكون الإجابة مختصرة مثل 'مرحبًا، كيف يمكنني مساعدتك اليوم؟'. أما إذا تطلب السؤال تفاصيل أو معلومات إضافية، قدّم إجابة شاملة ومنظمة، لكن دون إفراط في التفاصيل غير المطلوبة. قسّم المعلومات إلى أجزاء واضحة وسهلة الفهم، واستخدم أسلوبًا احترافيًا ووديًا. تأكد دائمًا من أن الإجابة تركز على النقطة الرئيسية، واطلب توضيحًا بلطف إذا كان السؤال غامضًا.

            سؤال المستخدم: ${question}

            إجابتك:
            `;
            return promptTemplate;
        }

        async function sendMessageToAI(message, imageBase64 = null) {
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);

            const prompt = createPrompt(message);

            const url = "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=" + apiKey;
            const data = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            if (imageBase64) {
                data.contents[0].parts.push({
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: imageBase64
                    }
                });
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                chatMessages.removeChild(typingIndicator);

                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    let aiResponse = result.candidates[0].content.parts[0].text;
                    aiResponse = aiResponse.replace(/^إجابتك:\s*/, '');
                    addMessage(aiResponse, 'ai');
                } else {
                    addMessage("حدث خطأ في معالجة الرد. يرجى المحاولة مرة أخرى.", 'ai');
                }
            } catch (error) {
                console.error('Error:', error);
                chatMessages.removeChild(typingIndicator);
                addMessage("حدث خطأ أثناء الاتصال بالذكاء الاصطناعي. يرجى التحقق من اتصالك بالإنترنت.", 'ai');
            }
        }

        function handleImageUpload() {
            const file = imageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    addMessage(reader.result, 'user', 'image');
                    sendMessageToAI("ماذا ترى في هذه الصورة", reader.result.replace(/^data:image\/(png|jpeg|jpg);base64,/, ""));
                };
            }
        }

        imageButton.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', handleImageUpload);

        // دالة لإظهار أو إخفاء نافذة الإشعارات
        function toggleNotifications() {
          const popup = document.getElementById('notificationsPopup');
          const badge = document.getElementById('notificationsBadge');

          // إظهار/إخفاء النافذة
          popup.classList.toggle('show');

          // إخفاء النقطة عند عرض الإشعارات
          if (popup.classList.contains('show')) {
            badge.classList.remove('show');
            markAllNotificationsAsRead();
          }
        }

        // دالة لوضع علامة "مقروء" على جميع الإشعارات
        function markAllNotificationsAsRead() {
          const notifications = document.querySelectorAll('.notification-item.unread');
          notifications.forEach(notification => {
            notification.classList.remove('unread');
          });
        }

        // دالة لتحديث محتوى الإشعار
        function updateNotificationContent(notificationId, newContent) {
          const notification = document.getElementById(notificationId);
          if (notification) {
            const contentElement = notification.querySelector('.content');
            contentElement.textContent = newContent;

            // تحديث الوقت
            const timestampElement = notification.querySelector('.timestamp');
            timestampElement.textContent = getFormattedTimestamp();
          }
        }

        // دالة للحصول على الوقت الحالي بتنسيق مقروء
        function getFormattedTimestamp() {
          const now = new Date();
          return now.toLocaleString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
          });
        }

        // دالة لإضافة إشعار جديد (اختياري)
        function addNotification(content) {
          const popup = document.getElementById('notificationsPopup');
          const item = document.createElement('div');
          item.classList.add('notification-item', 'unread');
          item.innerHTML = `
            <div class="content">${content}</div>
            <div class="timestamp">${getFormattedTimestamp()}</div>
          `;
          item.addEventListener('click', () => {
            item.classList.remove('unread');
            updateBadgeVisibility();
          });
          popup.appendChild(item);
          showBadge(); // إظهار النقطة عند إضافة إشعار جديد
        }

        // دالة لإظهار النقطة
        function showBadge() {
          const badge = document.getElementById('notificationsBadge');
          badge.classList.add('show');
        }

        // إغلاق نافذة الإشعارات عند النقر خارجها
        document.addEventListener('click', (event) => {
          const popup = document.getElementById('notificationsPopup');
          const icon = document.querySelector('.notifications-icon');
          if (!popup.contains(event.target) && !icon.contains(event.target)) {
            popup.classList.remove('show');
          }
        });

        // تحديث محتوى الإشعار الأول
        updateNotificationContent('notification1', 'تحديث الموقع جارٍ');

        // إظهار النقطة مبدئيًا عند تحميل الصفحة (اختياري)
        showBadge();

        // معالج حدث النقر على زر الإرسال
        sendButton.addEventListener('click', (event) => {
          event.preventDefault(); // منع إعادة تحميل الصفحة
          const message = userInput.value;
            if (message.trim() !== '') {
                addMessage(message, 'user');
                lastUserMessage = message; // تحديث آخر رسالة من المستخدم
                sendMessageToAI(message);
                userInput.value = '';
            }
        });

        // معالج حدث الضغط على زر "Enter" في حقل إدخال النص
        userInput.addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault(); // منع السلوك الافتراضي (إرسال النموذج)
            const message = userInput.value;
            if (message.trim() !== '') {
                addMessage(message, 'user');
                lastUserMessage = message; // تحديث آخر رسالة من المستخدم
                sendMessageToAI(message);
                userInput.value = '';
            }
          }
        });
    </script>
</body>
</html>